<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/media/a15f2fce4b98b461-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/3d9ea938b6afa941-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/ee285b05ac47a625-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/1de9c871cd3a3669-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/bf54e24be5d8358f-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/media/02701f268eb7de16-s.p.woff2" as="font" type="font/woff2" crossorigin="anonymous" data-next-font="size-adjust"/><link rel="preload" href="/_next/static/css/69510bfdb63b0012.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/69510bfdb63b0012.css" crossorigin="" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-59c5c889f52620d6.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/framework-66d32731bdd20e83.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/main-aa55ffd08992d156.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/_app-9f85f92bf56823a0.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/108-ababe0d3bb81df72.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/posts/tag/%5Btag%5D-6f0344953c5fcd5a.js" defer="" crossorigin=""></script><script src="/_next/static/s88PCpXBXr-JVfKLNHdeM/_buildManifest.js" defer="" crossorigin=""></script><script src="/_next/static/s88PCpXBXr-JVfKLNHdeM/_ssgManifest.js" defer="" crossorigin=""></script></head><body><div id="__next"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{"tags":["react native","트러블슈팅","google map","expo-location","졸업작품","react","JavaScript","deepdive","useState","hook","next.js","SSR","Suspense","렌더링","테스트","dev tools","SSG","Algorithm","프로그래머스","PCCP","lv2","이분탐색","클로저","생명주기","Virtual DOM","백준","gold","dfs","lv3","bfs","all"],"currentTag":"google map","posts":[{"slug":"posts/React Native/React Native에서 Google Maps 연동 및 위치 추적 기능 구현하기","title":"React Native에서 Google Maps 연동 및 위치 추적 기능 구현하기","date":"2025-03-25T13:40:00.000Z","image":"index.png","summary":"React Native에서 Google Maps 연동 및 위치 추적 기능 구현하고, 초기 위치 설정하는 과정에서 발생한 문제를 해결하는 과정입니다.","tags":["react native","트러블슈팅","google map","expo-location","졸업작품"],"content":"\r\n# React Native에서 Google Maps 연동 및 위치 추적 기능 구현하기\r\n\r\n## 1. 개요\r\n\r\n최근 졸업작품인 러닝 크루 앱을 개발하면서 `react native`를 처음 써보았다. 앱에서 사용자의 현재 위치 및 코스 표시를 위해  `react-native-maps`를 활용해 Google Maps를 연동하였고, 사용자의 위치는 `expo-location`을 활용해 실시간으로 받아왔다.\r\n\r\n본 게시글에서는 `expo-location`을 통해 사용자의 위치를 받아오는 방법, `react-native-maps`를 통해 구글맵을 연동하는 방법 및 위치를 지도에 마커로 표시하는 과정, 그리고 러닝 중이라는 가정하에 지도의 중심이 사용자의 위치를 따라가도록 하는 것을 다뤄볼 것이다.\r\n그리고 끝으로 지도의 초기 위치를 내위치로 설정하던 과정에서 발생했던 문제도 다뤄볼 예정이다.\r\n\r\n## 2. 환경 설정\r\n\r\n### 2.1. 라이브러리 설치\r\n\r\nGoogle Maps를 React Native에서 사용하기 위해 `react-native-maps`를 설치한다.\r\n\r\n```\r\nnpx expo install react-native-maps\r\n```\r\n\r\n추가로, 현재 위치를 가져오기 위해 `expo-location`을 설치한다.\r\n\r\n```\r\nnpx expo install expo-location\r\n```\r\n\u003e npx expo install로 설치하는 이유: \r\n\u003e나 같은 경우 expo를 사용하여 react native개발을 하고 있고, 이 명령어를 사용하면 expo에서 공식적으로 지원하는 패키지 버전으로 라이브러리가 설치된다고 한다. \r\n\u003e그렇기 때문에 expo를 사용할때는 가급적 npm install 보다는 npx expo install을 권장한다고 한다.\r\n\r\n### 2.2. Google Maps API 키 설정\r\n\r\nGoogle Maps API를 사용하려면 Google Cloud Platform에서 API 키를 발급받아야 한다.\r\n\r\n그러기 위해서\r\n\r\n1. 구글 콘솔에서 프로젝트를 만든다\r\n2. api 및 서비스에 들어가서 `Maps for javascript sdk`를 허용한다.\r\n\u003cimg src=\"1.png\" alt=\"api 및 서비스 허용\"/\u003e\r\n3. 그 다음 키 및 사용자 인증정보 항목에서 api키를 만들기로 api 키를 만든다.\r\n\u003cimg src=\"2.png\" alt=\"api키 생성\"/\u003e\r\n- 키의 제한은 따로 없게했다. 보안을 위해서는 android용과  ios까지 따로따로 하는게 좋지만, 우선 본 게시글에선 따로 제한은 없게 할 것이다.\r\n\u003cimg src=\"3.png\" alt=\"키의 제한없도록 하기\"/\u003e\r\n4. app.json에서 이런식으로 키를 넣어 구글맵을 설정한다.\r\n- android는 app.json의 \"android\"안에 아래 코드를 추가한다.\r\n```json\r\n\"config\": {\r\n\t\"googleMaps\": {\r\n\t\t\"apiKey\": \"apikey\"\r\n}\r\n```\r\n\r\n-  ios까지 설정해주려면면 이런식으로 app.json안에 설정해준다.\r\n```json\r\n\"ios\": {\r\n\t\"bundleIdentifier\": \"com.company.runnershigh\",\r\n\t\"supportsTablet\": true,\r\n\t\"config\": {\r\n\t\t\"googleMapsApiKey\": \"apikey\"\r\n\t}\r\n},\r\n```\r\n이렇게 하면 기본적인 설정은 끝이난다.\r\n## 3. 구현\r\n\r\n### 3.1 MapView를 사용하여 지도를 보여주기\r\n```js\r\nimport MapView, { PROVIDER_GOOGLE } from \"react-native-maps\";\r\n      \u003cMapView\r\n        style={styles.map}\r\n        provider={PROVIDER_GOOGLE}\r\n        initialRegion={{\r\n          latitude: 37.78825,\r\n          longitude: -122.4324,\r\n          latitudeDelta: 0.02,\r\n          longitudeDelta: 0.02,\r\n        }}\r\n      \u003e\r\n      \u003c/MapView\u003e\r\n```\r\n`PROVIDER_GOOGLE`을 사용하면 MapView에 굳이 키를 직접 추가하지 않더라도 미리 키가 설정되어있다면 google map을 사용할 수 있다.\r\n`initialRegion`은 말그대로 맵이 로드될 때 처음 위치를 말한다.\r\n### 3.2. MapView에 현재 위치 표시하기\r\n사용자의 현재 위치를 받아오기 위해 `expo-location`을 사용했다.\r\n\r\n\r\n\r\n```js\r\nimport * as Location from \"expo-location\";\r\n\r\n  const [permissionStatus, requestPermission] =\r\n    Location.useForegroundPermissions();\r\n```\r\n` Location.useForegroundPermissions()`을 통해, 앱이 켜져있을 때 사용자의 위치를 받는 것의 권한을 물어볼 수 있다.\r\n이를 포함하여 askPermission이라는 함수로\r\n```js\r\nconst askPermission = async () =\u003e {\r\n    if (!permissionStatus || !permissionStatus.granted) {\r\n      const permission = await requestPermission();\r\n      if (!permission.granted) {\r\n        return Alert.alert(\"위치 권한 필요\", \"위치 권한을 허용해주세요.\");\r\n      }\r\n    }\r\n  };\r\n```\r\n이렇게 권한을 받도록 하였다.\r\n이 `askPermission`이라는 코드는 \r\n```js\r\n  const [myLocation, setMyLocation] =\r\n    useState\u003cLocation.LocationObjectCoords | null\u003e(null);\r\n  const [subscription, setSubscription] =\r\n    useState\u003cLocation.LocationSubscription | null\u003e(null);\r\n```\r\n사용자의 위치를 받는 myLocation과 위치 구독정보를 받는 subscription이라는 상태를 지정해준다음,\r\n\r\n```js\r\n// 위치 추적 시작\r\nconst startLocationTracking = async () =\u003e {\r\n  const sub = await Location.watchPositionAsync(\r\n    {\r\n      accuracy: Location.Accuracy.High,\r\n      timeInterval: 3000, // 3초마다 업데이트\r\n      distanceInterval: 5, // 5m 이동마다 업데이트\r\n    },\r\n    (newLocation) =\u003e {\r\n      setMyLocation(newLocation.coords);\r\n    }\r\n  );\r\n  setSubscription(sub);\r\n};\r\n```\r\n`Location.watchPositionAsync()` 함수는 사용자의 위치를 실시간으로 받아오게 하고, 이것을 활용하여, 사용자의 위치와 위치 구독 정보를 업데이트한다.\r\n\r\n```js\r\nconst stopLocationTracking = () =\u003e {\r\n  if (subscription) {\r\n    subscription.remove();\r\n    setSubscription(null);\r\n  }\r\n};\r\n```\r\n위치 추적을 멈추게하는 코드는 다음과 같다. 위치 구독정보를 삭제해주는 코드이다.\r\n\r\n이를 `useEffect`를 통해 \r\n```js\r\nuseEffect(() =\u003e {\r\n  startLocationTracking();\r\n  return () =\u003e {\r\n    stopLocationTracking();\r\n  };\r\n}, []);\r\n```\r\n이런식으로 지정해주어 컴포넌트가 처음 마운트 될 때에 위치추적을 시작하고, 언마운트되면 위치추적을 그만둔다.\r\n\r\n`initialRegion`도 사용자의 위치를 지정해준다.\r\n```js\r\nconst mapRef = useRef\u003cMapView\u003e(null);\r\nmyLocation \u0026\u0026 (\r\n  \u003cMapView\r\n    ref = {mapRef}\r\n    style={{ flex: 1 }}\r\n    provider={PROVIDER_GOOGLE}\r\n    initialRegion={{\r\n            latitude: myLocation?.latitude,\r\n            longitude: myLocation?.longitude,\r\n            latitudeDelta: 0.02,\r\n            longitudeDelta: 0.02,\r\n          }}\r\n/\u003e\r\n)\r\n```\r\n\r\n### 3.3. 지도 중심이 사용자의 위치에 맞게 이동하게 하기\r\n\r\n이제 러닝중이라는 것을 가정하고, 현재 위치를 기준으로 지도 중심을 이동시켜 볼 것이다.\r\n우선 `MapView`의 인스턴스에 직접 접근하기 위해 ref를 사용해야 한한다.\r\n\r\n```js\r\nconst mapRef = useRef\u003cMapView\u003e(null);\r\n\r\n\u003cMapView\r\n  ref = {mapRef}\r\n  style={{ flex: 1 }}\r\n  provider={PROVIDER_GOOGLE}\r\n  {/*...*/}  \r\n\u003e\r\n```\r\n이런식으로 `mapRef`를 통해 `MapView`의 인스턴스에 직접 접근할 수 있도록 한다.\r\n그 다음 만일 사용자의 위치를 카메라가 따라가고 싶게 만들고 싶다면, \r\n```js\r\nconst mapRef = useRef\u003cMapView\u003e(null);\r\n\r\nuseEffect(() =\u003e {\r\n  if (myLocation) {\r\n    mapRef.current?.animateCamera({\r\n      center: myLocation,\r\n      zoom: 18,\r\n    });\r\n  }\r\n}, [myLocation]);\r\n```\r\n이런식으로 아까 지정해 준 `myLocation`을 `useEffect`의 의존성으로 집어넣어 주고, `MapView`의 인스턴스중 `animateCamera`라는 인스턴스를 이렇게 사용하여 `myLocation`에 카메라가 고정이 되도록(카메라가 사용자의 위치를 따라가도록) 할 수 있다.\r\n\r\n\r\n## 문제 해결 : 초기 위치의 범위가 지나치게 커지는 현상\r\n`initialRegion`의 latitudeDelta와 longitudeDelta가 적용이 되지 않았고, 마커자체는 내 위치이지만 지도 범위가 초기에 대한민국 한반도 전체가 보이는 문제가 발생했다.\r\n```js\r\nmyLocation \u0026\u0026 (\r\n\u003cMapView\r\n        style={styles.map}\r\n        provider={PROVIDER_GOOGLE}\r\n        initialRegion={{\r\n          latitude: myLocation?.latitude,\r\n          longitude: myLocation?.longitude,\r\n          latitudeDelta: 0.02,\r\n          longitudeDelta: 0.02,\r\n        }}\r\n      \u003e\r\n      \u003c/MapView\u003e\r\n)\r\n```\r\ninitialRegion은 처음에만 위치가 적용이되고, 그 이후에 위치가 바뀌는 것은 적용이 되지 않는다고 하는데, myLocation은 지속적으로 위치추적을 하는 코드이기 때문에 지속적으로 비동기적으로 업데이트가 된다. 그래서 그 부분에서 꼬이지 않았나 생각이 든다. \r\n\r\n그래서 이부분에 대해서 고민을 해보았고, 지도의 레이아웃이 처음에 지도를 로드할 때만 바뀌고, 그 이후에는 바뀌지 않는다라는 생각에 `MapView`의 `onLayout`이에 `animateToRegion`으로 지도의 중심 및 범위를 이동시키는 코드를 넣어봤다.\r\n\r\n- `onLayout`: MapView가 화면에 배치될 때(즉, 첫 렌더링될 때) 호출되는 이벤트(뷰의 위치와 크기를 할당하는 단계이다.)\r\n- `animateToRegion(region, duration)`: 지도 영역을 애니메이션으로 이동하는 함수\r\n```js\r\n\u003cMapView\r\n        style={styles.map}\r\n        provider={PROVIDER_GOOGLE}\r\n        initialRegion={{\r\n          latitude: myLocation?.latitude,\r\n          longitude: myLocation?.longitude,\r\n          latitudeDelta: 0.02,\r\n          longitudeDelta: 0.02,\r\n        }}\r\n        onLayout={() =\u003e {\r\n              if (mapRef.current) {\r\n                mapRef.current.animateToRegion(\r\n                  {\r\n                    latitude: myLocation?.latitude,\r\n                    longitude: myLocation?.longitude,\r\n                    latitudeDelta: 0.02,\r\n                    longitudeDelta: 0.02,\r\n                  },\r\n                  0\r\n                );\r\n              }\r\n            }}\r\n      /\u003e\r\n\r\n```\r\n\r\n하지만, 헤더에서 장소를 검색하여 위치를 이동시키는 기능을 구현하던 도중 문제가 발생했는데, 키보드를 열 때마다 지도가 자동으로 리사이징이 되면서 `onLayout` 안의 코드가 실행이 되는 것이었다.\r\n\r\n내가 원하는건 지도가 처음 로드가 될 때 초기에 한번만 지도가 내 위치로 설정이 되는 것인데, 키보드가 열릴때마다 원치않게 내 위치로 지도가 자동 이동이 되는 문제가 발생했다.\r\n\r\n결국 `onLayout`이 아닌 MapView의 또다른 콜백 메소드인 **onMapReady**를 통해 문제를 해결했다.\r\n\r\n- `onMapReady`: 지도가 준비되었을 때 호출되는 콜백 메서드이며, 안의 코드는 지도가 준비되었을 때 초기에 한번만 실행된다.\r\n\r\n```js\r\n\u003cMapView\r\n        style={styles.map}\r\n        provider={PROVIDER_GOOGLE}\r\n        initialRegion={{\r\n          latitude: myLocation?.latitude,\r\n          longitude: myLocation?.longitude,\r\n          latitudeDelta: 0.02,\r\n          longitudeDelta: 0.02,\r\n        }}\r\n        onMapReady={() =\u003e {\r\n              if (mapRef.current) {\r\n                mapRef.current.animateToRegion(\r\n                  {\r\n                    latitude: myLocation?.latitude,\r\n                    longitude: myLocation?.longitude,\r\n                    latitudeDelta: 0.02,\r\n                    longitudeDelta: 0.02,\r\n                  },\r\n                  0\r\n                );\r\n              }\r\n            }}\r\n      /\u003e\r\n```\r\n이제 키보드가 열려도 위치가 이동하지 않았다!\r\n"}]},"__N_SSG":true},"page":"/posts/tag/[tag]","query":{"tag":"google map"},"buildId":"s88PCpXBXr-JVfKLNHdeM","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>